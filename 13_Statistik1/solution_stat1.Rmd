##  Musterlösung Aufgabe 1.1: Assoziationstest

**kommentierte Musterlösungen**
```{r, message=T, purl = F, include=FALSE}
## ladet die nötigen Packete und die novanimal.csv Datei in R

library(tidyverse)
nova <- read_delim("13_Statistik1/data/novanimal.csv", delim = ";")

## definiert mytheme für ggplot2 (verwendet dabei theme_classic())

mytheme <- 
  theme_classic() + 
  theme(
    axis.line = element_line(color = "black"), 
    axis.text = element_text(size = 20, color = "black"), 
    axis.title = element_text(size = 20, color = "black"), 
    axis.ticks = element_line(size = 1, color = "black"), 
    axis.ticks.length = unit(.5, "cm")
    )

```



```{r}
# Als eine Möglichkeit, die Aufgabe 1.1 zu bearbeiten, nehmen wir hier den novanimal-Datensatz und gehen der folgenden Frage nach: Gibt es einen Zusammenhang zwischen Geschlecht und der Wahl des Menüinhalts (vegtarisch vs. fleischhaltig) in der Mensa

# berücksichtigt nur vegetarische und fleischhaltige Menüs
# 1) alle Buffet-Menüs weglassen
# 2) alle veganen Gerichte zu vegetarische Gerichte umbenennen
nova2<-subset(nova, !(nova$label_content=="Buffet")) #Subset des Datensatzes ohne Buffet (Da Buffet nicht Fleisch/Vegetarisch zugordnet werden kann)

nova2$label_content[nova2$label_content %in% c('Pflanzlich','Pflanzlich+')] <- "Vegetarisch" # Überschreibt das Label "Pflanzlich","Pflanzlich+" mit "Vegetarisch"

nova2$label_content[grep("Pflanzlich+", nova2$label_content)] <- "Vegetarisch" # alternativer Lösungsweg

nova3<-droplevels(nova2) #entfernt die Kategorien die nicht mehr mehr benutzt werden

#Anzahl Vegetarische/FleischMenüs pro Geschlecht~Vegetarisch Base R
observed<-table(nova2$gender, nova2$label_content) 


#Anzahl Vegetarische/FleischMenüs pro Geschlecht~Vegetarisch Tidyverse
#braucht in diesem speziellen Fall viel mehr Code, da der Chi-Quadrat-Test am liebsten Matrizen will
# unser Vorschlag, nehmt den table Befehl
# untenstehend der vollständige Code in Tidyverse
observed_t <- nova2 %>% 
  group_by(gender, label_content) %>% 
  summarise(tot = n()) %>% 
  ungroup() %>%
  spread(., key = label_content, value = tot) %>%  #
  # set_rownames(.$gender) %>% funktioniert leider nicht mehr mit tibble
  select(-gender) %>%
  as.matrix()


#Chi-squared Test
chi_sq <- chisq.test(observed)
chi_sq

#Fisher's Test 
fisher.test(observed)
```

** Ergebnisse **
Der $\chi^2$-Test sagt uns, dass das Geschlecht und die Kaufentscheidung eines Menüinhalts zusammenhängen. Es gibt signifikante Unterscheide zwischen dem Geschlecht und dem Menüinhalt ($\chi^2$(`r chi_sq$parameter`) = `r round(chi_sq$statistic[[1]], digits = 3)`, *p* > .001). Es sieht so aus, dass Männer rund doppel so viel Fleischgerichte wählen als Frauen (siehe Tabelle 1). Die Ergebnisse müssen jedoch mit Vorsicht interpretiert werden, denn der $\chi^2$-Test gibt uns nur an, dass ein signifikanter Unterschied zwischen Geschlecht und Menüinhalt vorliegt. Um die Unterschiede innerhalb der Gruppen festzustellen bedarf es weiterer Analysen z. B. einer mehrfaktorieller ANOVA mit anschliessenden Post-hoc Tests (siehe Statistik 2, Folien 3 bis 11).

```{r, echo=F}
library(reshape2)
table <- as.data.frame(observed) %>%
  mutate(`Verkaufszahlen (%)` = round(Freq / sum(Freq) * 100, 1)) %>% 
  rename(Geschlecht = Var1, Menüinhalt = Var2, Verkaufszahlen = Freq) %>% 
  mutate(Geschlecht = recode(Geschlecht, "F" = "Frauen", "M" = "Männer"))
knitr::kable(table, caption = "Tabelle 1 \n Verkaufszahlen des Menüinhalts nach Geschlecht")

```


*******

### Musterlösung Aufgabe 1.2: $\chi^2$-Test
> Zur eurer Info: dies ist eine spezielle, aber wichtige Anwendung eines $\chi^2$-Tests
> Meine Empfehlung Kapitel "Single factor classification" von [Manny Gimond](https://mgimond.github.io/Stats-in-R/ChiSquare_test.html)


** Null- und Alternativhypothese**
> Beachtet: ungerichtet vs. gerichtete Hypothesen (z. B. Statistik 1, Folie 24)
> Überblick zu Hypothesentestung dazu: https://www.youtube.com/watch?v=F4c0EjsDvzo 
 
$H_0$: Es gibt keine Unterschiede zwischen der Population und der Stichprobe bezüglich Geschlecht und Hochschulzugehörigkeit. 
\par
$H_1$: Es gibt Unterschiede zwischen der Population und der Stichprobe bezüglich Geschlecht und Hochschulzugehörigkeit.

```{r}
# bereitet eure Daten auf
# gruppiert die Variablen und fasst sie 
# nach Geschlecht und Hochschulzugehörigkeit zusammen 
# fügt Information aus der Aufgabenstellung hinzu: absolute Häufigkeiten der Gesamtheit
# für den Chi-Quardrat-Test ist eine Berechnung der relativen Häufigkeiten nötig

df_t <- group_by(nova, gender, member) %>% 
  summarise(stichprobe = n()) %>% 
  ungroup() %>%
  mutate(canteen_member = c("Mitarbeiterinnen", "Studentinnen", "Mitarbeiter", "Studenten"), # Achtung: Reihenfolge muss stimmten vgl. canteen_member
         gesamtheit = c(345, 719, 339, 816), # Achtung: Reihenfolge muss stimmten vgl. oben
         gesamtheit_pct = gesamtheit / sum(gesamtheit),
         stichprobe_pct = stichprobe / sum(stichprobe)) # Berechnung der relativen Häufigkeiten

# berechnet den Chi-Quadrat-Test

chi_sq <- chisq.test(df_t$stichprobe, p = df_t$gesamtheit_pct) # es werden zwei Informationen übergeben, eure beobachteten Werte (stichprobe) und die in der Grundgesamtheit/Population erwarteten Werte (wichtig als relative Häufigkeiten)

chi_sq

```

** Methoden **

Ziel war es die NOVANIMAL Stichprobe gemäss Geschlecht und Hochschulzugehörigkeit in der Grundgesamtheit besser einzuordnen. Die Grundgesamtheit definiert sich durch alle aktiven CampusCards. Dafür ist ein einfaktorieller $\chi^2$-Test notwendig (siehe [Manny Gimond](https://mgimond.github.io/Stats-in-R/ChiSquare_test.html)). Dieser sagt uns nämlich, ob die beobachteten Häufigkeiten/Frequenzen aus unser Stichprobe mit einer definierten erwarteten Häufigkeit/Frequenz (hier der Grundgesamtheit) übereinstimmen. 

** Ergebnisse **

Der $\chi^2$-Test sagt uns, dass die NOVANIMAL-Stichprobe von der Population signifikant unterscheidet ($\chi^2$(`r chi_sq$parameter`) = `r round(chi_sq$statistic[[1]], digits = 3)`, *p* > .001). Demnach ist unsere Stichprobe bezüglich den Variablen Geschlecht und Hochschulzugehörigkeit nicht repräsentativ für die Grundgesamtheit. Es scheint, dass die Studentinnen unter- und die Studenten übervertreten sind (siehe Tabelle 2).

```{r, echo=F}
table <- df_t %>% 
  rename(Hochschulzugehörigkeit = member, `Anzahl Population` = gesamtheit, `Anzahl Stichprobe` = stichprobe, `Anteil Population (%)` = gesamtheit_pct, `Anteil Stichprobe (%)` = stichprobe_pct) %>%
  dplyr::select(Hochschulzugehörigkeit, `Anzahl Population`, `Anteil Population (%)`, `Anzahl Stichprobe`, `Anteil Stichprobe (%)`) %>% 
  mutate(`Anteil Stichprobe (%)` = round(`Anteil Stichprobe (%)`,2)*100, `Anteil Population (%)` = `Anteil Population (%)`*100)
knitr::kable(table, caption = "Tabelle 2 \nAnzahl und Anteil Beobachtungen in der Population und in der Stichprobe")

```

*******

###  Musterlösung Aufgabe 1.3: t-Test
> Meine Empfehlung Kapitel 2 von [Manny Gimond](https://mgimond.github.io/Stats-in-R/z_t_tests.html) 

** Null- und Alternativhypothese **
<>$H_0$: Es gibt keine Unterschiede in den Verkaufszahlen zwischen Basis- und Interventionswochen. <>
\par
$H_1$: Es gibt Unterschiede in den Verkaufszahlen zwischen Basis- und Interventionswochen.


```{r}
# Gemäss Aufgabenstellung müsset die Daten zuerst nach Kalenderwochen "week" und Bedingungen "condition" zusammengefasst werden

df <- nova %>%
    group_by(week, condit) %>%  
    summarise(tot_sold = n()) 

# überprüft die Voraussetzungen für einen t-Test
ggplot(df, aes(x = condit, y= tot_sold)) + # achtung 0 Punkt fehlt
    geom_boxplot(fill = "white", color = "black", size = 1) + 
    labs(x="\nBedingungen", y="Durchschnittlich verkaufte Gerichte pro Woche\n") + 
    mytheme

# Auf den ersten Blick scheint es keine starken Abweichungen zu einer Normalverteilung zu geben resp. es sind keine extremen schiefen Verteilungen ersichtlich (vgl. Statistik 2, Folien 12-21)

```


```{r}

# führt einen t-Tests durch; 
# es wird angenommen, dass die Verkaufszahlen zwischen den Bedingungen unabhängig sind

t_test <- t.test(tot_sold~condit, data=df)

t.test(df[df$condit == "Basis", ]$tot_sold, 
                 df[df$condit == "Intervention", ]$tot_sold) #alternative Formulierung

```

** Methoden **

Ziel war es die wöchentlichen Verkaufszahlen zwischen den Interventions- und Basiswochen zu vergleichen. Die Annahme war, dass die wöchentlichen Verkaufszahlen unabhängig sind. Daher können die mittleren Verkaufszahlen pro Woche zwischen den beiden Bedingungen mittels t-Test geprüft werden. Obwohl die visuelle Inspektion keine schwerwiegenden Verletzungen der Modelvoraussetzung zeigte, wurde einen Welch t-Test gerechnet. 

** Ergebnisse **

In den Basiswochen werden mehr Gerichte pro Woche verkauft als in den Interventionsowochen (siehe Abbildung 1). Die wöchentlichen Verkaufszahlen zwischen den Bedigungen (Basis oder Intervention) unterscheiden sich gemäss Welch t-Test jedoch nicht signifikant (*t*(`r round(t_test$parameter[[1]],digits = 0)`) = `r round(t_test$statistic, digits = 3)` , *p* = `r round(t_test$p.value, digits=3)`).


```{r, purl=F, message=F, echo = F,  fig.cap="Abbildung1. Die wöchentlichen Verkaufszahlen für die Interventions- und Basiswochen unterscheiden sich nicht signifikant."}
# zeigt die Ergebnisse mit einer Abbildung
ggplot(df, aes(x = condit, y= tot_sold)) + 
  stat_boxplot(geom ='errorbar', width = .25) + # erzeugt sogenannte Whiskers mit Strichen
  geom_boxplot(fill = "white", color = "black", size = 1) +
  labs(x="\nBedingungen", y="Durchschnittlich verkaufte Gerichte pro Woche\n") + 
  mytheme

```


<!-- ******* -->
<!-- ##### letztes Update `r Sys.Date()`, gian-andrea.egeler@zhaw.ch & stefan.widmer@zhaw.ch -->
