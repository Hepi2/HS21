---
title: Musterloesung
output: distill::distill_article

---

```{r echo = FALSE}
knitr::opts_chunk$set(error = TRUE)
```
---
output:
  pdf_document: default
  html_document: default
---
## Musterloesung Aufgabe 2.3S: ANOVA mit Interaktion
******

>**Lese-Empfehlung** Kapitel 7 von [Manny Gimond](https://mgimond.github.io/Stats-in-R/ANOVA.html)

>Download [R-Skript](14_Statistik2/RFiles/solution_stat2.3s.R)

>Download [PDF](14_Statistik2/RFiles/solution_stat2.3s.pdf)

******


**kommentierter Lösungsweg**

```{r, message=FALSE, echo=FALSE, results='hide', warning=FALSE}

library(tidyverse)
library(here)


## ladet die nötigen Packete und die novanimal.csv Datei in R
nova <- read_delim(here::here("13_Statistik1/data/2017_ZHAW_individual_menu_sales_NOVANIMAL.csv"), 
                   delim = ";")

## definiert mytheme für ggplot2 (verwendet dabei theme_classic())
mytheme <- 
  theme_classic() + 
  theme(
    axis.line = element_line(color = "black"), 
    axis.text = element_text(size = 12, color = "black"), 
    axis.title = element_text(size = 12, color = "black"), 
    axis.ticks = element_line(size = .75, color = "black"), 
    axis.ticks.length = unit(.5, "cm")
    )


```


```{r, message=FALSE}
# klone den originaler Datensatz
df <- nova 

# Daten vorbereiten
df %<>% # schaut euch das Package "magrittr" an
  # ersetze Local mit einem leeren String
  mutate(article_description = str_replace(article_description, "Local ", "")) %>% 
  filter(article_description != "Hot and Cold") %>% # lasse Buffet Gerichte weg
  filter(member != "Spezialkarten") %>% # Spezialkarten können vernachlässigt werden
  #  fasse die zwei Menülinien "World & Favorite" zusammen
  mutate(article_description = str_replace_all(article_description, "Favorite|World",
                                               "Fav_World"))  

# gruppiere Daten nach Menülinie, Geschlecht und Hochschulzugehörigkeit
df %<>%
    group_by(article_description, member, week) %>% 
    summarise(tot_sold = n()) %>%
    ungroup() %>% 
    drop_na()  # lasst die unbekannten Menü-Inhalte weg

# überprüft die Voraussetzungen für eine ANOVA
# Schaut euch die Verteilungen der Mittelwerte der Responsevariable an
# Sind Mittelwerte nahe bei Null? Gäbe uns einen weiteren Hinweis auf 
# eine spezielle Binomail-Verteilung (vgl. Statistik 4)
df %>% 
  split(.$article_description) %>% # teilt den Datensatz in 3 verschiedene Datensätze auf
  # mit map können andere Funktionen auf den Datensatz angewendet werden 
  # (alternative Funktionen sind aggregate oder apply)
  purrr::map(~ psych::describe(.$tot_sold)) 


# visualisiere dir dein Model, was siehst du? 
# sind möglicherweise gewiesse Voraussetzungen verletzt?
# Boxplot
ggplot(df, aes(x = interaction(article_description, member), y= tot_sold)) + 
   # Achtung: Reihenfolge spielt hier eine Rolle!
  stat_boxplot(geom = "errorbar", width = 0.25) +
  geom_boxplot(fill="white", color = "black", size = 1, width = .5) +
  labs(x = "\nMenülinie nach Hochschulzugehörigkeit", y = "Anzahl verkaufte Gerichte\n") + 
  scale_x_discrete(limits = c("Fav_World.Mitarbeitende", "Kitchen.Mitarbeitende",
                              "Fav_World.Studierende", "Kitchen.Studierende"),
                   breaks = c("Fav_World.Mitarbeitende", "Fav_World.Studierende",
                              "Kitchen.Mitarbeitende",  "Kitchen.Studierende"),
                   labels = c("Fav_World\nMitarbeitende", "Fav_World\nStudierende",
                              "Kitchen\nMitarbeitende",  "Kitchen\nStudierende")) +
  mytheme # wie sind die Voraussetzungen erfüllt?


# definiert das Modell (Skript Statistik 2)
model <- aov(tot_sold ~ article_description * member, data = df)

summary.lm(model)

# überprüft die Modelvoraussetzungen (Statistik 2)
par(mfrow = c(2,2)) # alternativ gäbe es die ggfortify::autoplot(model) funktion
plot(model)


```

<span style="background-color: #FFFF00"> **Fazit**: Die Inspektion des Modells zeigt kleinere Verletzungen bei der Normalverteilung der Residuen (Q-Q Plot). Aufgrund keiner starken Verbesserung durch eine Transformation der Responsevariable, entscheide ich mich für eine ANOVA ohne log-tranformierten Responsevariablen (AV).</span>

```{r}
# sieht aus, als ob die Voraussetzungen für eine Anova nur geringfügig verletzt sind
# mögliche alternativen: 
# 1. log-transformation um die grossen werte zu minimieren (nur möglich, wenn 
# keine 0 enthalten sind und die Mittelwerte weit von 0 entfernt sind 
# => bei Zähldaten ist dies leider nicht immer gegeben)
# 2. nicht parametrische Test z.B. Welch-Test, da hohe Varianzheterogenität 
# zwischen den Residuen


#1) log-transformation
model_log <- aov(log10(tot_sold) ~ article_description * member, data = df)

summary.lm(model_log) # interaktion ist nun nicht mehr signifikant: vgl. 
# nochmals euren Boxplot zu beginn, machen diese Koeffizienten sinn?

# überprüft die Modelvoraussetzungen (vgl. Skript Statistik 2)
# bringt aber keine wesentliche Verbesserung, daher bleibe ich bei den 
# untranfromierten Daten
par(mfrow = c(2,2))
plot(model_log)

# post-hov Vergleiche
TukeyHSD(model)

```

*******

**Methode**

Ziel war es die Unterschiede zwischen den preisgünstigeren und teureren Menülinien und der Hochschulzugehörigkeit herauszufinden: Hierfür wurde eine ANOVA mit Interaktion gerechnet, da wir eine (quasi)-metrische Responsevariable und zwei Prädiktorvariablen (Menülinie und Hochschulzugehörigkeit) haben. Die Voraussetzungen für eine ANOVA waren im ersten Model nicht stark verletzt, lediglich die Normalverteilung der Residuen: Deshalb habe wurde auf eine log-Transformation der Responsevariable verzichtet. Anschliessend wurden noch post-hoc Einzelvergleiche nach Tukey durchgeführt.


*******


**Ergebnisse**

Die wöchentlichen Verkaufszahlen der Menülinien unterscheiden sich nach Hochschulzugehörigkeit signifikant (F(3,44) = `r round(summary.lm(model_log)[[10]]["value"][[1]], 2)`, p < .001). Inhaltich bedeutet dies, dass Studierende signifikant häufiger die preisgünstigere Menülinie "Favorite & World" als Mitarbeitende kaufen. Entgegen der Annahme gibt es aber keine signifikanten Unterschiede zwischen Studierende und Mitarbeitende bei dem Kauf der teureren Menülinie "Kitchen". Über die möglichen Gründe können nur spekuliert werden, hierfür bedarf es weiteren Analysen z.B. mit dem Prädiktor "Menüinhalt".


```{r, message=F, echo=F, fig.cap="Box-Whisker-Plots der wöchentlichen Verkaufszahlen pro Menü-Inhalte. Kleinbuchstaben bezeichnen homogene Gruppen auf *p* < .05 nach Tukeys post-hoc-Test."}

# zeigt die Ergebnisse anhand eines Boxplots
library(multcomp)

# bei Interaktionen gibt es diesen Trick, um bei den multiplen Vergleiche, 
# die richtigen Buchstaben zu bekommen
df$cond_label <- interaction(df$article_description, df$member) #
model1 <- aov(tot_sold ~ cond_label, data = df)
letters <-cld(glht(model1, linfct=mcp(cond_label="Tukey")))

ggplot(df, aes(x = interaction(article_description, member), y= tot_sold)) + 
  stat_boxplot(geom = "errorbar", width = 0.25) + 
  geom_boxplot(fill="white", color = "black", size = .75, width = .5) +
  labs(x = "\nMenülinie nach Hochschulzugehörigkeit", y = "Anzahl verkaufte Gerichte\n") + 
  scale_x_discrete(limits = c("Fav_World.Mitarbeitende", "Kitchen.Mitarbeitende",
                              "Fav_World.Studierende", "Kitchen.Studierende"),
                   breaks = c("Fav_World.Mitarbeitende", "Fav_World.Studierende",
                              "Kitchen.Mitarbeitende",  "Kitchen.Studierende"),
                   labels = c("Fav_World\nMitarbeitende", "Fav_World\nStudierende",
                              "Kitchen\nMitarbeitende",  "Kitchen\nStudierende")) +
  annotate("text", x = 1:4, y = 1000, label = letters$mcletters$Letters, size = 6) +
  mytheme 

ggsave("plot1_solution2.3s.pdf",
       height = 12,
       width = 20,
       device = cairo_pdf)

``` 
