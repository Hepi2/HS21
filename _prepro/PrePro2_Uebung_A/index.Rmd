---
title: Uebung A
output: distill::distill_article
categories:
- PrePro2
- PrePro
author:
  - name: Patrick Laube
  - name: Nils Ratnaweera
  - name: Nikolaos Bakogiannis
---

```{r echo = FALSE}

```
```{r include=FALSE, purl=F}
knitr::opts_chunk$set(echo = TRUE, include = F, collapse=TRUE)
# knitr::opts_knit$set(root.dir = "10_PrePro2") 

select <- dplyr::select


```



```{r,message=F}
library(tidyverse)
library(lubridate)
library(stringr)
```


## Aufgabe 1

Lade die Wetterdaten runter ([weather.csv](weather.csv)) und importiere sie in `R`.

```{r}
# Lösung Aufgabe 1

wetter <- read_csv("weather.csv",
                  col_types = list(
                    col_factor(levels = NULL),    
                    col_datetime(format = "%Y%m%d%H"),
                    col_double()
                    )
                  )
```


## Aufgabe 2

Bereinige den Datensatz. Entferne z.B. alle Zeilen, bei dem der Stationsnahme oder Temperaturwerte fehlen 

```{r}
# Lösung Aufgabe 2

wetter <- wetter %>%
  filter(!is.na(stn)) %>%
  filter(!is.na(tre200h0))

```

## Aufgabe 3

Importiere die Datei [metadata.csv](metadata.csv) (z.B. mit `read_delim`).

Hinweis: Wenn Umlaute und Sonderzeichen nicht korrekt dargestellt werden (z.B. in Gen*è*ve), hat das vermutlich mit der [Zeichencodierung](https://de.wikipedia.org/wiki/Zeichenkodierung) zu tun. Das File ist aktuell in 'ANSI' Codiert, welche für gewisse Betriebssysteme / R-Versionen ein Problem darstellt. Um das Problem zu umgehen muss man das File mit einem Editor öffnen (Windows 'Editor' oder 'Notepad++', Mac: 'TextEdit') und mit einer neuen Codierung (z.B 'UTF-8') abspeichern. Danach kann die Codierung spezifitiert werden (bei `read_delim(): mit `locale = locale(encoding = "UTF-8")`)

```{r}

# Lösung Aufgabe 4

wetter_legende <- read_delim("metadata.csv",
                             delim = ";", 
                             locale = locale(encoding = "UTF-8"))

```



## Aufgabe 4


Die x-/y-Koordinaten sind aktuell in einer Spalte erfasst. Um mit den Koordinaten sinnvoll arbeiten zu können, brauchen wir die Koordinaten getrennt. Trenne die `x` und `y` Koordinaten aus der Spalte `Koordinaten`.

1. Schritt: verwende `stringr::str_split_fixed` um die Spalte in eine `matrix` zu überführen
2. Schritt: benenne die Spalten der `matrix` in `x` und `y` um
3. Schritt: nutze `cbind` um die `matrix` mit der `data.frame` zu verbinden

```{r}

# Lösung Aufgabe 5

# 1. Schritt
koordinaten <- str_split_fixed(wetter_legende$Koordinaten, "/", 2)
# 2. Schritt
colnames(koordinaten) <- c("x","y")
# 3. Schritt
wetter_legende <- cbind(wetter_legende,koordinaten)
```


## Aufgabe 5

Nun wollen wir den Datensatz `wetter`mit den Informationen aus `wetter_legende`anreichern. Uns interessiert aber nur das Stationskürzel, der Name, die x/y Koordinaten sowie die Meereshöhe. Lösche die nicht benötigten Spalten (oder selektiere die benötigten Spalten).

```{r, message=F}

# Lösung Aufgabe 6

wetter_legende <- wetter_legende[,c("stn", "Name", "x","y","Meereshoehe")]
```


## Aufgabe 7

Nun ist der Datensatz `wetter_legende` genügend vorbereitet. Jetzt kann er mit dem Datensatz `wetter` verbunden werden. Überlege dir, welcher Join dafür sinnvoll ist und mit welchem Attribut wir "joinen" können.

Nutze die Join-Möglichkeiten von `dplyr` (Hilfe via `?dplyr::join`)  um die Datensätze `wetter` und `wetter_legende`zu verbinden.

```{r}

# Lösung Aufgabe 7

wetter <- left_join(wetter,wetter_legende,by = "stn")

# Jointyp: Left-Join auf 'wetter', da uns nur die Stationen im Datensatz 'wetter' interessieren.
# Attribut: "stn"
```

## Aufgabe 8

Berechne die Durchschnittstemperatur pro Station. Speichere das Resultat in einer neuen Variabel.


```{r,warning=F}

# Lösung Aufgabe 8
unique(wetter$stn)

```

## Aufgabe 9

Nun wollen wir das Resultat aus Aufgabe 7 nutzen, um die Durchschnittstemperatur der Meereshöhe gegenüber zu stellen. Dummerweise ging das Attribut `Meereshoehe` bei der `summarise()` Operation verloren (da bei `summarise()` alle Spalten weg fallen, die **nicht** in `group_by()` definiert wurden). Um die Spalte `Meereshoehe` beizubehalten, muss sie also unter `group_by()` aufgelistet werden. 

Wiederhole Übung 7 und siehe zu, dass die Meereshöhe beibehalten wird. Stelle danach in einem Scatterplot (wenn möglich mit `ggplot()`) die Meereshöhe der Durchschnittstemperatur gegenüber.

```{r}
# Lösung Aufgabe 9

wetter_sry <- wetter %>%
  group_by(stn,Meereshoehe) %>%
  summarise(temp_mean = mean(tre200h0))

# Achtung: wenn mehrere Argumente in group_by() definiert werden führt das 
# üblicherweise zu Untergruppen. In unserem Fall hat jede Station nur EINE 
# Meereshöhe, deshalb wird die Zahl der Gruppen nicht erhöht.
```


```{r}
ggplot(wetter_sry, aes(temp_mean,Meereshoehe)) +
  geom_point()
```


