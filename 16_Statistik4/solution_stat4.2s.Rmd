## Musterlösung Aufgabe 4.2S: multiple logistische Regression
> Meine Empfehlung Kapitel 6 von Manny Gimond https://mgimond.github.io/Stats-in-R/Logistic.html

**kommentierter Lösungsweg**
```{r, message=FALSE, echo=FALSE, results='hide', warning=FALSE}

library(dplyr)
library(magrittr)
library(data.table)
library(lubridate)
library(ggplot2)
library(stringr)
library(tidyr)

# lade Daten von Zenodo
# für Informationen zu den einzelnen Variablen, siehe https://zenodo.org/record/3554884/files/2020_ZHAW_vonRickenbach_Variablen_cleaned_recoded_survey_dataset_anonym_NOVANIMAL.pdf?download=1
nova_survey <- data.table::fread("https://zenodo.org/record/3554884/files/2019_ZHAW_vonRickenbach_cleaned_recorded_survey_dataset_NOVANIMAL_anonym.csv?download=1", sep = ";", encoding = "Latin-1") %>% 
  mutate(date = as_date(date)) %>% 
  as_tibble()

#überprüfe die Datenstruktur
glimpse(nova_survey)

## definiert mytheme für ggplot2 (verwendet dabei theme_classic())

mytheme <- 
  theme_classic() + 
  theme(
    axis.line = element_line(color = "black"), 
    axis.text = element_text(size = 20, color = "black"), 
    axis.title = element_text(size = 20, color = "black"), 
    axis.ticks = element_line(size = 1, color = "black"), 
    axis.ticks.length = unit(.5, "cm")
    )

```


```{r}

# Genereiert eine Dummyvariable: Fleisch 1, kein Fleisch 0
df <- nova_survey %>%  # kopiert originaler Datensatz
  rename(umwelteinstellung = tho_2) %>% # änderung name der variable
  mutate(umwelteinstellung = case_when(umwelteinstellung == 4 ~ 1,
                                       umwelteinstellung == 3 ~ 1,
                                       umwelteinstellung == 2 ~ 0, 
                                       umwelteinstellung == 1 ~ 0)) %>% 
  dplyr::filter(!str_detect(string = "x", gender)) %>% # lasse die kleine Gruppe mit x weg
  dplyr::filter(!str_detect(string = "Andere", member)) %>%  # lasse die kleine Gruppe "andere" weg
  dplyr::select(mensa, age_groups, gender, member, umwelteinstellung, meat) # wähle nur die relevanten variablen aus

# Schaut euch die Missings an in der Kriteriumsvariable "mensa"
sum(is.na(df$mensa))

# schaut euch die Missings an in den Prädiktorvariablen "Alter", "Geschlecht", "Hochschulzugehörigkeit", "umwelteinstellung"
Amelia::missmap(df) # vieles deutet darauf hin, dass die missings (fehlende Werte) zufällig zustande gekommen sind (sog. MCAR); für mehr Informationen: https://uvastatlab.github.io/2019/05/01/getting-started-with-multiple-imputation-in-r/

#bester Weg wäre, die wenigen fehlenden Werte zu imputieren; einfachheitshalber löschen wir sie aber :)
df %<>%
  drop_na()

#  sieht euch die Verteilung zwischen Mensagänger und Selbstverpfleger an 
table(df$mensa) # sind nicht gleichmässig verteilt, bei der Vorhersage müssen wir das berücksichtigen

# definiert das logistische Modell und wendet es auf den Datensatz an

mod0 <-glm(mensa ~ gender + member + age_groups + meat + umwelteinstellung, data = df, binomial("logit"))
summary.lm(mod0) # Umwelteinstellung scheint keinen Einfluss auf die Verpflegung zu haben, gegeben die Daten

# neues Modell ohne Umwelteinstellung
mod1 <- update(mod0, ~. -umwelteinstellung)
summary.lm(mod1)

# Modeldiagnostik (wenn nicht signifikant, dann OK)
1 - pchisq(mod1$deviance, mod1$df.resid) # Ok

#Modellgüte (pseudo-R²)
1 - (mod1$dev / mod1$null) # eher kleines pseudo-R² 


# Konfusionsmatrix vom  Datensatz
# Model Vorhersage
# hier ein anderes Beispiel: 
predicted <- predict(mod1, df, type = "response")

# erzeugt eine Tabelle mit den beobachteten
# Mensagänger/Selbstverpfleger und den Vorhersagen des Modells
km <- table(df$mensa, predicted > 0.5) # alles was höher ist als 50% ist kommt in die Kategorie Mensagänger

dimnames(km) <- list(
  c("Beobachtung Selbstverpf.", "Beobachtung Mensagänger"),
  c("Modell Selbstverpfl.", "Modell Mensagänger"))
km
# es scheint, dass das Modell häufig einen alpha Fehler zu machen, d.h. es das Modell hat keine hohe Spezifizität aufweist: konkret werden viele Selbstverpfleger als Mensagänger vorhergesagt resp. klassifiziert. Dafür gibt es mehere Gründe: 
#1) die Kriteriumsvariable ist sehr ungleich verteilt, d.h. es gibt weniger Selbstverpfleger als Mensgänger im Datensatz 
#2) Overfitting des Modells auf die Daten 
#3) nicht adäquates Modell zB link mit probit zeigt besserer fit

# Achtung Overfitting wurde hier nicht berücksichtigt, in einem Paper müsste hier noch einen Validierungstest gemacht werden z.B. test-train Cross-Validation oder k fold Cross-Validation 

# kalkuliert die Missklassifizierungsrate 
mf <- 1-sum(diag(km)/sum(km)) # ist mit knapp 23% eher hoch
mf


```


**Methode**

In der Aufgabe war es das Ziel zu schauen, ob wir einen potenziellen Besuch eines Mensagasts vorhersagen können und zwar in Abhängigkeit von den sozioökonimischen Variablen, wahrgenommene Fleischkonsum und der Umwelteinstellung. Die Kriteriumsvariable "Mensa" weist eine binäre Verteilung auf: Deshalb rechnen wir eine multiple logistische Regression mit den Prädiktoren “Alter”, “Geschlecht”, “Hochschulzugehörigkeit”, "Fleischkonsum" und "Umwelteinstellung. Mehr Informatinen zu den logistischen Regressinen findet ihr im Buch von Crawley (2015) oder auch im Buch von [Gareth (2016)](http://faculty.marshall.usc.edu/gareth-james/ISL/ISLR%20Seventh%20Printing.pdf), Kapitel 4.3; passendes Video [hier](https://www.youtube.com/watch?v=31Q5FGRnxt4&list=PL5-da3qGB5IC4vaDba5ClatUmFppXLAhE&index=2).



*******


**Ergebnisse**


```{r, fig.cap="Tabelle 1: Konfusionsmatrix"}
knitr::kable(km)
```


Der Output des logistischen Models mit der Linkfunktin "logit" sagt und, dass das Modell nicht gut zu den Daten passt, d.h. mit dem Modell (gegeben die Daten) können wir nur schlecht vorhersagen, ob eine Person zukünftig sich in der Mensa verpflegt oder ihr Mittagessen selber mitnimmt. Hinweise dafür geben das kleine pseudo-R2 (14%) als auch die hohe Missklassifizierungsrate (24%): bei genauerer Betrachtung fällt auf, dass das Modell häufig einen alpha-Fehler begeht, d.h. unser Modell sagt zu viele Selbstverpfleger vorher, obwohl diese in Realität Mensagänger sind. 
Es gibt verschiedene Gründe für diesen schlechten Modelfit:

* die Kriteriumsvariable ist sehr ungleich verteilt, d.h. es gibt weniger Selbstverpfleger als Mensgänger im Datensatz (26% vs. 74%)
* die Prädiktorvariablen sind alle entweder kategorial oder ordinal: dies kann dazu führen, dass das Model keinen guten fit erzielt 

Fazit: Es sollte nach einem weiteren adäquateren Modell gesucht werden: insbesondere ein Modell, welches einen mit ordinalen Prädiktorvariablen umgehen kann z.B. proportionale ordinale logistische Regression (MASS::polr()) oder eine bessere Link-Funktion suchen z.B. probit



































