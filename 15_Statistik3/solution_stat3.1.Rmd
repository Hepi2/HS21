---
title: "MSc. Research Methods - Statistikteil Lösungen 2019"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r}
knitr::opts_chunk$set(results = "hide", fig.width = 20, fig.height = 12, warning = F, message = F, fig.pos = 'H')
```

## Musterlösung Aufgabe 3.1: Multiple Regression

[Demoscript als Download](15_Statistik3/RFiles/Loesung_Uebung_3.1_v.02.R)

**Übungsaufgabe (hier so ausführlich formuliert, wie dies auch in der Klausur der Fall sein
wird)**

- Bereiten Sie den Datensatz Ukraine.xlsx für das Einlesen in R vor und lesen Sie ihn
dann ein. Dieser enthält gemittelte Pflanzenartenzahlen (Species.richness) von 199
10 m² grossen Plots (Vegetationsaufnahmen) von Steppenrasen in der Ukraine sowie
zahlreiche Umweltvariablen, deren Bedeutung und Einheiten im Kopf der ExcelTabelle angegeben sind.
- **Ermitteln Sie ein minimal adäquates Modell, das den Artenreichtum in den Plots
durch die Umweltvariablen erklärt.**
- Bitte erklären und begründen Sie die einzelnen Schritte, die Sie unternehmen, um zu
diesem Ergebnis zu kommen. Dazu erstellen Sie bitte ein Word-Dokument, in das Sie
Schritt für Schritt den verwendeten R-Code, die dazu gehörigen Ausgaben von R, Ihre
Interpretation derselben und die sich ergebenden Schlussfolgerungen für das weitere
Vorgehen dokumentieren.
- Dieser Ablauf sollte insbesondere beinhalten:
    - Überprüfen der Datenstruktur nach dem Einlesen: welches sind die abhängige(n)
      und welches die unabängige(n) Variablen, sind alle Variablen für die Analyse
      geeignet?
    - Explorative Datenanalyse, um zu sehen, ob die abhängige Variable in der
      vorliegenden Form für die Analyse geeignet ist
    - Definition eines globalen Modelles und dessen Reduktion zu einem minimal
      adäquaten Modell
    - Durchführen der Modelldiagnostik für dieses
    - Generieren aller Zahlen, Statistiken und Tabellen, die für eine wiss.
      Ergebnisdarstellung benötigt werden
    - Formulieren Sie abschliessend einen Methoden- und Ergebnisteil (ggf. incl.
      adäquaten Abbildungen) zu dieser Untersuchung in der Form einer
      wissenschaftlichen Arbeit (ausformulierte schriftliche Zusammenfassung, mit je
      einem Absatz von ca. 60-100 Worten, resp. 3-8 Sätzen für den Methoden- und
      Ergebnisteil). D. h. alle wichtigen Informationen sollten enthalten sein, unnötige
      Redundanz dagegen vermieden werden.
    - **Abzugeben sind am Ende (a) Ein lauffähiges R-Skript; (b) begründeter Lösungsweg
      (Kombination aus R-Code, R Output und dessen Interpretation) und (c)
      ausformulierter Methoden- und Ergebnisteil (für eine wiss. Arbeit).**
      
      
**Loesung Übung 3.1: Multiple Regression**

```{r}
# Aus der Excel-Tabelle wurde das relevante Arbeitsblatt als csv gespeichert
ukraine <-read.csv("15_Statistik3/data/Ukraine_bearbeitet.csv",sep=";")
attach(ukraine)

ukraine
str(ukraine)
summary(ukraine)
```
Man erkennt, dass alle Spalten bis auf die erste mit der Plot ID numerisch (num oder int) und
dass die abhängige Variable in Spalte 2 sowie die Prediktorvariablen in den Spalten 3 bis 23
stehen.

```{r}
#Explorative Datenanalyse der abhängigen Variablen
boxplot(Species.richness)
```

Der Boxplot sieht sehr gut symmetrisch aus. Insofern gibt es keinen Anlass über eine
Transformation nachzudenken. (Da es sich bei Artenzahlen um Zähldaten handelt, müsste man
theoretisch ein glm mit Poisson-Verteilung rechnen; bei einem Mittelwert, der hinreichend von
Null verschieden ist (hier: ca. 40), ist eine Poisson-Verteilung aber praktisch nicht von einer
Normalverteilung zu unterscheiden und wir können uns den Aufwand auch sparen).

```{r}
cor <- cor(ukraine[,3:23])
cor
cor[abs(cor)<0.7] <- 0
cor
```
Die Korrelationsanalyse dient dazu, zu entscheiden, ob die Prädiktorvariablen hinreichend
voneinander unabhängig sind, um alle in das globale Modell hinein zu nehmen. Bei Pearson’s
Korrelationskoeffizienten r, die betragsmässig grösser als 0.7 sind, würde es problematisch.
Alternativ hätten wir auch den VIF (Variance Inflation Factor) als Kriterium für den möglichen
Ausschluss von Variablen aus dem globalen Modell nehmen können.
Diese initiale Korrelationsanalyse zeigt uns aber, dass unsere Daten noch ein anderes Problem
haben: für die drei Korngrössenfraktionen des Bodens (Sand, Silt, Clay) stehen lauter NA’s. Um
herauszufinden, was das Problem ist, geben wir ein:

```{r}
summary(ukraine$Sand)
```
Da gibt es offensichtlich je ein NA in jeder dieser Zeilen. Jetzt können wir entscheiden,
entweder auf die drei Variablen oder auf die eine Beobachtung zu verzichten. Da wir eh schon
eher mehr unabhängige Variablen haben als wir händeln können, entscheide ich pragmatisch
für ersteres. Wir rechnen die Korrelation also noch einmal ohne diese drei Spalten (es sind die
Nummern 12:14, wie wir aus der anfänglichen Variablenbetrachtung oben wissen).

```{r}
cor <- cor(ukraine[,c(3:11,15:23)])
cor[abs(cor)<0.7] <- 0
cor
```
Wenn man auf cor nun doppel-clickt und es in einem separaten Fenster öffnet, sieht man, wo
es problematische Korrelationen zwischen Variablenpaaren gibt.
Es sind dies Altitude vs. Temperature und N.total vs. C.org. Wir müssen aus jedem dieser Paare
jetzt eine Variable rauswerfen, am besten jene, die weniger gut interpretierbar ist. Ich
entscheide mich dafür Temperature statt Altitude (weil das der direktere ökologische
Wirkfaktor ist) und C.org statt N.total zu behalten (weil es in der Literatur mehr Daten zum
Humusgehalt als zum N-Gehalt gibt, damit eine bessere Vergleichbarkeit erzielt wird). Die
Aussagen, die wir für die beibehaltene Variable erzielen, stehen aber +/- auch für die
entfernte.
Das Problem ist aber, dass wir immer noch 16 Variablen haben, was einen sehr
leistungsfähigen Rechner oder sehr lange Rechenzeit erfordern würde. Wir sollten also unter
15 Variablen kommen. Wir könnten uns jetzt überlegen, welche uns ökologisch am wichtigsten
sind, oder ein noch strengeres Kriterium bei r verwenden, etwa 0.6

```{r}
cor <- cor(ukraine[,c(3:11,15:23)])
cor[abs(cor)<0.6] <- 0
cor
```
Entsprechend „werfen“ wir auch noch die folgenden Variablen „raus“: Temperature.range
(positiv mit Temperature), Precipitation (negativ mit Temperature) sowie Conductivity (positiv
mit pH).

Nun können wir das globale Modell definieren, indem wir alle verbleibenden Variablen
aufnehmen, das sind 13. (Wenn das nicht eh schon so viele wären, dass es uns an die Grenze
der Rechenleistung bringt, hätten wir auch noch darüber nachdenken können, einzelne
quadratische Terme oder Interaktionsterme zu berücksichtigen).

```{r}
global.model <- lm (Species.richness ~
Inclination+Heat.index+Microrelief+Grazing.intensity+Litter+
Stones.and.rocks+Gravel+Fine.soil+pH+CaCO3+C.org+CN.ratio+Temperature)
```

Nun gibt es im Prinzip zwei Möglichkeiten, vom globalen (vollen) Modell zu einem minimal
adäquaten Modell zu kommen. (1) Der Ansatz der „frequentist statistic“, in dem man aus dem
vollen Modell so lange schrittweise Variablen entfernt, bis nur noch signifikante Variablen
verbleiben. (2) Den informationstheoretischen Ansatz, bei dem alle denkbaren Modelle
berechnet und verglichen werden (also alle möglichen Kombinationen von 13,12,…, 1, 0
Parametern). Diese Lösung stelle ich im Folgenden vor:

```{r}
#Multimodel inference
library(MuMIn)
options(na.action="na.fail")
allmodels<-dredge(global.model)
allmodels
```

Jetzt bekommen wir die besten der insgesamt 8192 möglichen Modelle gelistet mit ihren
Parameterschätzungen und ihrem AICc.

Das beste Modell umfasst 5 Parameter (CaCO3, CN.ratio, Grazing.intensity. Heat.index, Litter).
Allerdings ist das nächstbeste Modell (mit 6 Parametern) nur wenig schlechter (delta AICc =
0.71), was sich in fast gleichen (und zudem sehr niedrigen) Akaike weights bemerkbar macht.
Nach dem Verständnis des Information theoretician approach, sollte man in einer solchen
Situation nicht das eine „beste“ Modell benennen, sondern eine Aussage über die Gruppe der
insgesamt brauchbaren Modelle treffen. Hierzu kann man (a) Importance der Parameter über
alle Modelle hinweg berechnen (= Summe der Akaike weights aller Modelle, die den
betreffenden Parameter enthalten) und/oder (b) ein nach Akaike weights gemitteltes Modell
berechnen.

```{r}
#Importance values der Variablen
importance(allmodels)
```

Demnach ist Heat.index die wichtigste Variable (in 100% aller relevanten Modelle), während
ferner Litter, CaCO3, CN.ratio und Grazing.intensity in mehr als 50% der relevanten Modelle
enthalten sind.

```{r}
#Modelaveraging (Achtung: dauert mit 13 Variablen einige Minuten)
summary(model.avg(get.models(dredge(global.model,rank="AICc"),subset
=TRUE)))
```

Aus dem gemittelten Modell können wir die Richtung der Beziehung (positiv oder negativ) und
ggf. die Effektgrössen (wie verändert sich die Artenzahl, wenn die Prädiktorvariable um eine
Einheit zunimmt?) ermitteln.

```{r}
#Modelldiagnostik nicht vergessen
par(mfrow=c(2,2))
plot(global.model)
plot(lm(Species.richness~Heat.index+Litter+CaCO3+CN.ratio+Grazing.intensity))
```

Wie immer kommt am Ende die Modelldiagnostik. Wir können uns entweder das globale
Modell oder das Modell mit den 5 Variablen mit importance > 50% anschauen. Das Bild sieht
fast identisch aus und zeigt keinerlei problematische Abweichungen, d. h. links oben weder ein
Keil, noch eine Banane, rechts oben eine nahezu perfekte Gerade. 

**Darstellung der Vorgehensweise und Ergebnisse (in einer wiss. Arbeit)
Methoden
Es wurden Pflanzenartenzahlen von Steppenrasen in der Ukraine auf 199 10 m² grossen
Probeflächen erhoben und zu diesen 23 Umweltvariablen erhoben. Da jeweils ein Messwert
fehlte, wurden die Bodenvariablen Sand-, Schluff- und Tongehalt von der weiteren
statistischen Analyse ausgeschlossen. Mittels Pearson’s Korrelationskoeffizient wurde auf
Abhängigkeiten zwischen den Prädiktorvariablen getestet und aus Paaren mit einer
Beziehung mit |r| > 0.6 nur jeweils eine Variable beibehalten. Entsprechend wurden die
hoch mit Jahresmitteltemperatur korrelierten Werte Meereshöhe (negativ),
Temperaturamplitude (positiv) und Niederschlag (negativ) ausgeschlossen, ferner
Leitfähigkeit (positiv mit pH) und Stickstoffgehalt (positiv mit organischem
Kohlenstoffgehalt). Damit umfasste das globale lineare Modell (Funktion lm in R) die in Tab.
1 aufgeführten Variablen. Quadratische Terme oder Interaktionen zwischen Variablen
wurden nicht berücksichtigt. Auf ein glm mit Poisson-Regression wurde verzichtet, da eine
visuelle Inspektion eines Boxplots der Artenzahlen keine relevanten Abweichungen von
einer Normalverteilung ergab.
Die Modellauswahl fand mittels Multimodel Inference (dredge-Funktion im MuMIn package
in R) statt. Die Modellgüte wurde mittels AICc beurteilt. Zur Beurteilung der Bedeutung von
Variablen wurden Importance Values (Summe der Akaike weights in allen Modellen, die die
betreffende Variable beinhalten) ausgerechnet. Die Richtung der Beziehung wurde aus der
Parameterschätzung im globalen Modell bestimmt. Schliesslich wurde ein gemitteltes
Modell (aller möglichen Modelle, gewichtet nach deren Akaike weights) erstellt, um die
Effektgrössen zu bestimmen. Die Adäquanz des gewählten Modells wurde in Residualplots
visuell inspiziert und ergab keine nennenswerten Verletzungen der Voraussetzungen eines
parametrischen Modells.
Ergebnisse
Das beste Modell nach AICc beinhaltete die Variablen CaCO3, CN-Verhältnis,
Beweidungsintensität, Heat load-Index und Streuauflage. Da sich die nächstbesten Modelle
aber um weniger als DeltaAICc = 2 unterscheiden, wurden für die Gesamtbeurteilung die
Importance values sowie die Koeffizienten des über alle 8192 betrachteten Modelle nach
Akaike weights gemittelten average models herangezogen (Tab. 1). Mit einem Importance
value von nahezu 100% war der Heat load-Index die wichtigste Einflussgrösse (negativ). Vier
weitere Umweltvariablen waren ebenfalls in mehr als 50% der statistisch relevanten
Modelle enthalten (in dieser Reihenfolge):**

**Tab. 1. Ergebnisse der Multimodel Inference. Die Variablen sind nach absteigenden
Importance values sortiert. Die Parameterschätzung bezieht sich nur auf die Modelle, welche
die entsprechende Variable beinhalten und ist nach Akaike weights gewichtet. Unter
„Hochkorrelierte Variablen“ sind jene aufgeführt, die wegen ihres engen Zusammenhangs
mit der genannten Variablen nicht ins globale Modell aufgenommen wurden.**

![](15_Statistik3/data/tab1_uebungStatistik3.png)

