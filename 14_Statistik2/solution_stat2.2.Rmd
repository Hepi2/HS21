---
title: "MSc. Research Methods - Statistikteil Lösungen 2019"
author: "Gian-Andrea Egeler"
date: "`r format(Sys.Date(), '%B %Y')`"
output:
  html_document:
    df_print: paged
---

[RCode als Download](14_Statistik2/RFiles/Loesung_Uebung_2.3N_v.02.R)

## Musterlösung Aufgabe 2.2: einfaktorielle ANOVA

```{r, message=FALSE, echo=FALSE, results='hide', warning=FALSE}

library(tidyverse)
library(ggfortify) # zur Testung der Voraussetzungen

## ladet die nötigen Packete und die novanimal.csv Datei in R
nova <- read_delim("13_Statistik1/data/novanimal.csv", delim = ";")

## definiert mytheme für ggplot2 (verwendet dabei theme_classic())
mytheme <- 
  theme_classic() + 
  theme(
    axis.line = element_line(color = "black"), 
    axis.text = element_text(size = 20, color = "black"), 
    axis.title = element_text(size = 20, color = "black"), 
    axis.ticks = element_line(size = 1, color = "black"), 
    axis.ticks.length = unit(.5, "cm")
    )


```



```{r}

df <- nova # klone den originaler Datensatz

# fasst die vier Inhalte der Gerichte zu drei Inhalten zusammen.
df$label_content[grep("Pflanzlich+",df$label_content)] <- "Vegetarisch" 

# gruppiert Daten nach Menü-Inhalt und Woche
df_ <- df %>%
    group_by(label_content, week) %>% 
    summarise(tot_sold = n()) %>%
    drop_na() # lasst die unbekannten Menü-Inhalte weg

# überprüft die Voraussetzungen für eine ANOVA
# Schaut euch die Verteilungen der Mittelwerte an (plus Standardabweichungen)
# Sind Mittelwerte nahe bei Null? Gäbe uns einen weiteren Hinweis auf eine spezielle Binomail-Verteilung (Statistik 4, Folie: XY)
df_  %>% 
  split(.$label_content) %>% # teilt den Datensatz in 3 verschiedene Datensätze auf
  purrr::map(~ psych::describe(.$tot_sold)) # mit map können andere Funktionen auf den Datensatz angewendet werden


# Boxplot
ggplot(df_, aes(x = label_content, y= tot_sold)) + 
  stat_boxplot(geom = "errorbar", width = 0.25) + # Achtung: Reihenfolge spielt hier eine Rolle!
  geom_boxplot(fill="white", color = "black", size = 1, width = .5) +
  labs(x = "\nMenü-Inhalt", y = "Anzahl verkaufte Gerichte pro Woche\n") + 
  mytheme # achtung erster Hinweis einer Varianzheterogenität


# definiert das Modell (Statistik 2: Folien 4-8)
model <- aov(tot_sold ~ label_content, data = df_)

summary.lm(model)

# überprüft die Modelvoraussetzungen
autoplot(model) + mytheme 

```
<br>  
<span style="background-color: #FFFF00">Fazit: Inspektion der Modellvoraussetzung zeigt klare Verletzungen des Residuelplots (zeigt einen "Trichter", siehe Statistik 2: Folie 13-14; 42), somit Voraussetzung der Homoskedastizität verletzt. Mögliche nächste Schritte: Datentransformation oder nicht-parametrischer Test.</span>
<br>
```{r}

# überprüft die Voraussetzungen des Welch-Tests:
# Gibt es eine hohe Varianzheterogenität und ist die relative Verteilung der Residuen gegeben? (siehe Folien Statistik 2: Folie 18)
# Ja Varianzheterogenität ist gegeben, aber die Verteilung der Residuen folgt einem "Trichter", also keiner "normalen/symmetrischen" Verteilung um 0 (siehe Folien Statistik 2: Folie 42)
# Daher ziehe ich eine Transformation der AV dem nicht-parametrischen Test vor
model1 <- aov(log10(tot_sold) ~ label_content, data = df_)

autoplot(model) + mytheme # scheint ok zu sein

TukeyHSD(model1) # (Statistik 2: Folien 9-11)
```

-------

#### Methoden

Ziel war es, die Unterschide in den Verkaufszahlen pro Menü-Inhalt aufzuzeigen. Da die Responsvariable (AV: Verkaufszahlen) metrisch und die Prädiktorvariable (UV: Menü-Inhalt) kategorial sind, wurde eine einfaktorielle ANOVA gerechnet. Die visuelle Inspektion der Voraussetzungen zeigte insbesondere schwere Verletzungen der Homoskedastizität (siehe Statistik 2: Folien 13-14). Der Boxplot bestätigt diesen Befund. Daher wurde in einem weiteren Schritt eine Transformation oder einen nicht-parametrischen Testden Welch-Test für ungleiche Varianzen gerechnet.  

#### Ergebnisse

Die Menü-Inhalte (Fleisch, Vegetarisch und Buffet) unterscheiden sich in den Verkaufszahlen signifikant (*F*(2,15) = `r round(summary(model1)[[1]][["F value"]][1],2)`, *p* < .001). Die Abbildung zeigt die Verkaufszahlen pro Menü-Inhalt.

```{r, echo=F, fig.cap="Die wöchentlichen Verkaufzahlen unterscheiden sich je nach Menü-Inhalt stark.", tidy=T}

# plottet die Ergebnisse

# aufbereitung für die Infos der Signifikanzen => Alternative Lösungen findet ihr in der Musterlösung 2.3S
df1 <- data.frame(a = c(1, 1:3,3), b = c(150, 151, 151, 151, 150)) 
df2 <- data.frame(a = c(1, 1,2, 2), b = c(130, 131, 131, 130))
df3 <- data.frame(a = c(2, 2, 3, 3), b = c(140, 141, 141, 140))


ggplot(df_, aes(x = label_content, y= tot_sold)) +
   stat_boxplot(geom = "errorbar", width = .25) +
   geom_boxplot(fill="white", color = "black", size = 1, width = .5) + 
   geom_line(data = df1, aes(x = a, y = b)) + annotate("text", x = 2, y = 152, label = "***", size = 8) + # aus der Information aus dem Tukey Test von oben: Buffet-Vegetarisch
   geom_line(data = df2, aes(x = a, y = b)) + annotate("text", x = 1.5, y = 132, label = "***", size = 8) + # Buffet - Fleisch
   geom_line(data = df3, aes(x = a, y = b)) + annotate("text", x = 2.5, y = 142, label = "*", size = 8)+ # Fleisch - Vegetarisch
   expand_limits(y = 0) + # nimmt das 0 bei der y-Achse mit ein
   labs(x = "\nMenü-Inhalt", y = "Anzahl verkaufte Gerichte pro Woche\n") + 
   mytheme 

# hier ein paar interessante Links zu anderen R-Packages, die es ermöglichen signifikante Ergebniss in den Plot zu integrieren
# https://www.r-bloggers.com/add-p-values-and-significance-levels-to-ggplots/
# https://cran.r-project.org/web/packages/ggsignif/vignettes/intro.html
  
   
```

--------
letztes Update `r Sys.Date()`, gian-andrea.egeler@zhaw.ch
