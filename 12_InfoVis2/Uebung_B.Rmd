
```{r, include=F, purl = F}
library(knitr)
knitr::opts_chunk$set(echo = F,include = T,message = F, warning = F, collapse=TRUE)
# knitr::opts_knit$set(root.dir = "12_InfoVis2") 


output <- knitr::opts_knit$get("rmarkdown.pandoc.to") # html / latex


run_plotly_image = F # set to "TRUE" in order to create static images via plotly_api (max 100/day)
show_static_image = T # set to "TRUE" in order to show the image / "FALSE" to show error message
default_error <- "In der PDF Version kann die interaktive Grafik bis auf weiteres nicht dargestellt werden."

```

## Uebung B (Optional)

In dieser Übung bauen wir einige etwas unübliche Plots aus der Vorlesung nach. Dafür verwenden wir Datensätze, die in R bereits integriert sind. Eine Liste dieser Datensätze findet man [hier](https://stat.ethz.ch/R-manual/R-devel/library/datasets/html/00Index.html) oder mit der Hilfe `?datasets`.


Dazu verwenden wir vor allem das Package `plotly` welches im Gegensatz zu `ggplot2` ein paar zusätzliche Plot-Typen kennt und zudem noch interaktiv ist.  Leider scheinen gewisse Browsers (z.B. Firefox) sowie der Viewer Pane mit `plotly` Mühe zu haben. Deshalb empfehlen wir folgendes:

- [Übungsunterlagen für InfoVis2](http://oyster.zhaw.ch:3939/ResearchMethodsUebungen/) in Chrome zu öffnen
- Falls ihr auf dem [RStudio Server](http://oyster.zhaw.ch:8787) arbeitet: hier ebenfalls in Chrome arbeiten
- Falls ihr lokal mit RStudio arbeitet: Mit der Option `options(viewer=NULL)` werden Plots mit dem Standart Browser. 



```{r, echo = F,message=F}

library(tidyverse)
library(plotly)
library(pander)
library(webshot)

```


```{r, echo = F, purl= F}
Sys.setenv("plotly_username" = "rata_zhaw")
Sys.setenv("plotly_api_key" = "ae8Fn1ltcjUGvWYX957J")
```



### Aufgabe 1: Parallel coordinate plots

Erstelle einen [parallel coordinate plot](https://en.wikipedia.org/wiki/Parallel_coordinates). Dafür eignet sich der integrierte Datensatz [`mtcars`](https://stat.ethz.ch/R-manual/R-devel/library/datasets/html/mtcars.html):

```{r, echo = F, purl=F}

knitr::kable(head(mtcars))

```

```{r, echo = T, eval=F}

# Nur nötig, wenn ihr mit einer lokalen Installation von RStudio arbeitet
# (also nicht auf dem Server).
options(viewer=NULL)

```


Parallel Coordinates lassen sich mit nativem `ggplot2` nicht herstellen. Es braucht dazu entweder Erweiterungen oder "standalone" Tools. Als "standalone" Tool kann ich `plotly` stark empfehlen. `Plotly` verfügt zwar über eine etwas eigenwillige Syntax, bietet dafür über sehr vielseitige zusätzliche Möglichkeiten. Vor allem aber sind sämtliche `plotly` Grafiken webbasiert und interaktiv. 

Hier findet ihr eine Anleitung zur Herstellung eines Parallel Coordinates Plot mit `plotly`: https://plot.ly/r/parallel-coordinates-plot/

So sieht der fertige Plot aus:

```{r}
# Lösung Aufgabe 1

p <- mtcars %>%
  plot_ly(type = 'parcoords',
          line = list(color = ~mpg,
                      colorscale = list(c(0,'red'),c(1,'blue'))),
          dimensions = list(
            list(label = 'mpg', values = ~mpg),
            list(label = 'disp', values = ~disp),
            list(label = 'hp', values = ~hp),
            list(label = 'drat', values = ~drat),
            list(label = 'wt', values = ~wt),
            list(label = 'qsec', values = ~qsec),
            list(label = 'vs', values = ~vs),
            list(label = 'am', values = ~am),
            list(label = 'gear', values = ~gear),
            list(label = 'carb', values = ~carb)
          )
  )
```


```{r, results="asis", purl = F, echo=F}
aufgabe <- "aufgabe_1"
filename <- paste0("12_InfoVis2/",aufgabe,".png")

if(output == "latex"){
  if(run_plotly_image){plotly_IMAGE(p, format = "png", out_file = filename)} 
  if(show_static_image){pander::pandoc.image(filename)} else{pandoc.strong(default_error)}
} else(p)

```

### Aufgabe 2: Polar Plot mit Biber Daten

Polar Plots (welche man ebenfalls mit Plotly erstellen kann) eignen sich unter anderem für Daten, die zyklischer Natur sind, wie zum Beispiel zeitlich geprägte Daten (Tages-, Wochen-, oder Jahresrhythmen). Aus den Beispiels-Datensätzen  habe ich zwei Datensätze gefunden, die zeitlich geprägt sind:

- [`beaver1` und `beaver2`](https://stat.ethz.ch/R-manual/R-devel/library/datasets/html/beavers.html)
[`AirPassenger`](https://stat.ethz.ch/R-manual/R-devel/library/datasets/html/AirPassengers.html)

Beide Datensätze müssen noch etwas umgeformt werden, bevor wir sie für einen Radialplot verwenden können. In Aufgabe 2 verwenden wir die Biber-Datensätze, in der nächsten Aufgabe (3) die Passagier-Daten.

Wenn wir die Daten von beiden Bibern verwenden wollen, müssen wir diese noch zusammenfügen:
```{r, echo = T}


beaver1_new <- beaver1 %>%
  mutate(beaver = "nr1")

beaver2_new <- beaver2 %>%
  mutate(beaver = "nr2")

beaver_new <- rbind(beaver1_new,beaver2_new)

```

Zudem müssen wir die Zeitangabe noch anpassen: Gemäss der [Datenbeschreibung](https://stat.ethz.ch/R-manual/R-devel/library/datasets/html/beavers.html) handelt es sich bei der Zeitangabe um ein sehr programmier-unfreundliches Format. 3:30 wird als "0330" notiert. Wir müssen diese Zeitangabe, noch in ein Dezimalsystem umwandeln:
```{r, echo = T}
beaver_new <- beaver_new %>%
  mutate(
    hour_dec = (time/100)%/%1,         # Ganze Stunden (mittels ganzzaliger Division)
    min_dec = (time/100)%%1/0.6,       # Dezimalminuten (15 min wird zu 0.25, via Modulo)
    hour_min_dec = hour_dec+min_dec    # Dezimal-Zeitangabe (03:30 wird zu 3.5)
    ) 
```



Der Datensatz: 
```{r, echo = F, purl = F}
knitr::kable(head(beaver_new))
#  formatRound(c("min_dec","hour_min_dec"), 2)
```

So sieht der fertige Plot aus. Rekonstruiere dies mit `plotly`:

```{r}

# Lösung Aufgabe 2

p <- beaver_new %>%
  plot_ly(r = ~temp, t = ~hour_min_dec, color = ~beaver,mode = "lines", type = "scatter") %>%
  layout(
    radialaxis = list(range = c(35,39)),
    angularaxis = list(range = c(0,24)),
    orientation = 270,
    showlegend = F
    )
```

```{r, results="asis", purl = F, echo=F}
aufgabe <- "aufgabe_2"
filename <- paste0("12_InfoVis2/",aufgabe,".png")

if(output == "latex"){
  if(run_plotly_image){plotly_IMAGE(p, format = "png", out_file = filename)} 
  if(show_static_image){pander::pandoc.image(filename)} else{pandoc.strong(default_error)}
} else(p)

```




### Aufgabe 3: Polar Plot mit Passagier-Daten


Analog Aufgabe 2, dieses Mal mit dem Datensatz [`AirPassanger`](https://stat.ethz.ch/R-manual/R-devel/library/datasets/html/AirPassengers.html)

`AirPassengers` kommt in einem Format daher, das ich selbst noch gar nicht kannte. Es sieht zwar aus wie ein `data.frame` oder eine `matrix`, ist aber von der Klasse [`ts`](https://stat.ethz.ch/R-manual/R-devel/library/stats/html/ts.html).

```{r, echo = T}
AirPassengers

class(AirPassengers)
```


Damit wir den Datensatz verwenden können, müssen wir ihn zuerst in eine `matrix` umwandeln. Wie das geht habe ich [hier](https://stackoverflow.com/a/5332664/4139249) erfahren.
```{r, echo = T}
AirPassengers2 <- tapply(AirPassengers, list(year = floor(time(AirPassengers)), month = month.abb[cycle(AirPassengers)]), c)
```

Aus der `matrix` muss noch ein Dataframe her, zudem müssen wir aus der breiten Tabelle eine lange Tabelle machen:

```{r, echo = T}


AirPassengers3 <- AirPassengers2 %>%
  as.data.frame() %>%
  rownames_to_column("year") %>%
  gather(month,n,-year) %>%
  mutate(
    # ich nutze einen billigen Trick um ausgeschriebene Monate in Nummern umzuwandeln [1]
    month = factor(month, levels = month.abb,ordered = T),
    month_numb = as.integer(month),
    year = factor(year, ordered = T)
  )


# [1] beachtet an dieser Stelle das Verhalten von as.integer() wenn es sich um factors() handelt. Hier wird das Verhalten genutzt, andersweitig kann es einem zum Verhngnis werden. Das Verhalten wir auch hier verdeutlicht:
# as.integer(as.character("500"))
# as.integer(as.factor("500"))

```


Hier der fertige Plot. Rekonstruiere dies mit `plotly`:
```{r}

# Lösung Aufgabe 3

p <- AirPassengers3 %>%
  plot_ly(r = ~n, t = ~month_numb, color = ~year, mode = "markers", type = "scatter") %>%
  layout(
    showlegend = T,
    angularaxis = list(range = c(0,12)),
    orientation = 270,
    legend = list(traceorder = "reversed")
) 

```



```{r, results="asis", purl = F, echo=F}
aufgabe <- "aufgabe_3"
filename <- paste0("12_InfoVis2/",aufgabe,".png")

if(output == "latex"){
  if(run_plotly_image){plotly_IMAGE(p, format = "png", out_file = filename)} 
  if(show_static_image){pander::pandoc.image(filename)} else{pandoc.strong(default_error)}
} else(p)
```

### Aufgabe 4: 3D Scatterplot

Erstelle einen 3D Scatterplot, ebenfalls mit `plotly`. Nutze dazu den Datensatz `trees`. Ein Beispiel für einen 3D Scatterplot findet ihr [hier](https://plot.ly/r/3d-scatter-plots/).


```{r}

# Lösung Aufgabe 4

  p <- trees %>%
  plot_ly(x = ~Girth, y = ~Height, z = ~Volume)
```



```{r, results="asis", purl = F, echo=F}
aufgabe <- "aufgabe_4"
filename <- paste0("12_InfoVis2/",aufgabe,".png")

if(output == "latex"){
  if(run_plotly_image){plotly_IMAGE(p, format = "png", out_file = filename)} 
  if(show_static_image){pander::pandoc.image(filename)} else{pandoc.strong(default_error)}
} else(p)
```





