```{r, include=F, purl = F}
# knitr::opts_knit$set(root.dir = "14_Statistik2") 
```



```{r, message=F}
library(tidyverse)
library(ggfortify) # um autoplot() für lm/aov nutzen zu können

```



#### Beispiel 4: Simple linear regression - random X

[Script als Download](14_Statistik2/RFiles/Demo_01_Korr_Reg_Beispiel4.R)


Aus @logan2010 [S. 192]: Script an Tools/Packages des Moduls Research Methods angepasst

To investigated the nature of abundance-area relationships for invertebrates in intertidal mussel clumps, Peake and Quinn (1993) measured area (mm2) (dependent variable: AREA) and number of non-mussel individuals supported (response variable: INDIV) from a total of 25 intertidal mussel clumps(from Box 5.4 of Quinn and Keough (2002)).

##### Step 1

Import the Peake and Quinn (1993) data set [peake.csv](14_Statistik2/data/peake.csv)

```{r, message = F}

peake <- read.csv("14_Statistik2/data/peake.csv")

```


##### Step 2 

Assess linearity, normality and homogeneity of variance using a scatterplot with marginal boxplots and a lowess smoother



```{r, fig.cap="Conclusions - scatterplot of rawdata (left figure) indicates evidence of non-normality (boxplots not symmetrical) and evidence that homogeneity of variance my also be violated (points become more spread along the line of the regression line). Data transformed to logarithms (base 10) appear to meet the assumptions of normality and homogeneity of variance better (right figure). Linearity of the log-log relationship also appears reasonable [@logan2010]"}
p <- ggplot(peake, aes(AREA, INDIV)) +
  geom_point()+
  geom_smooth()

ggMarginal(p, type = "boxplot", size = 10)

```

```{r}
p <- p +
  scale_x_log10() +
  scale_y_log10()

ggMarginal(p, type = "boxplot", size = 10)
```


##### Step 3

The ordinary least squares method is considered appropriate as the main focus will be on hypothesis testing and generating a predictive model.


##### Step 4

Fit the simple linear regression model ($\gamma_i = \beta_0 + \beta_1\chi_i$) and examine the diagnostics.



```{r, fig.cap="Conclusions - There is a definite 'wedge pattern' evident in the residual plot which is indicative of a problem with homogeneity of variance. The Q-Q normal plot confirms that the response variable does deviate from normal. One of the points (observation 25, obscured by the legend) is close to the higher Cook’s D contours suggesting that this observation may be overly influential on the final fitted model [@logan2010]."}

peake.lm <- lm(INDIV ~ AREA, data = peake)


autoplot(peake.lm, label.size = 3) 


```


```{r, fig.cap="Conclusions - The residual plot resulting from a model based on log transformed data does not depict an obvious 'wedge', the Q-Q normal plot indicates a greater degree of normality and non of the points are close to the higher Cook’s D contours. This confirms that it is more appropriate to fit the linear model using the log transformed data [@logan2010]."}
peake.lm <- lm(log10(INDIV) ~ log10(AREA), data = peake)


autoplot(peake.lm, label.size = 3)

```


```{r}
peake.lm <- lm(log10(INDIV) ~ log10(AREA), data = peake)

autoplot(peake.lm, label.size = 3)

```
Conclusions - The residual plot resulting from a model based on log transformed data does not depict an obvious "wedge", the Q-Q normal plot indicates a greater degree of normality and non of the points are close to the higher Cook’s D contours. This confirms that it is more appropriate to fit the linear model using the log transformed data [@logan2010].


```{r}
influence.measures(peake.lm)
```

Conclusions - Whilst three leverage (hat) values are greater than $2*\frac{p}{n} = 0.16$ (observations 1, 2 and 3) and therefore potentially outliers in x-space, none of the Cook’s D values are $\ge$ 1 (no point is overly influential). No evidence that hypothesis tests will be unreliable [@logan2010].


##### Step 5

Examine the parameter estimates and hypothesis tests.
```{r}
summary(peake.lm)

```

Conclusions - Reject $H_0$ that the population slope equals zero. An increase in (log) mussel clump area was found to be associated with a strong ($r^2 = 0.859$), significant increase in the (log) number of supported invertebrate individuals ($b = 0.835$, $t_{23} = 11.816$, $P < 0.001$). 


##### Step 6

Summarize the findings of the linear regression analysis with a scatterplot including the regression line, regression equation and $r^2$.

```{r}

ggplot(peake, aes(AREA, INDIV))+
  geom_point() +
  scale_x_log10()+
  scale_y_log10() +
  labs(x = expression(paste("Mussel clump area (",mm^2,")")), y = "Number of individuals") +
  # geom_abline(intercept = peake.lm$coefficients[1], slope = peake.lm$coefficients[2]) +
  geom_smooth(method = "lm", se = 0.95, lty = 2) +
  annotate("text", x= 30000, y= 30, label = "log[10]*INDIV == 0.835~log[10]*AREA - 0.576", parse = T, hjust = 1) +
  annotate("text", x= 30000, y= 22, label = "r^{2}==0.835", parse = T,hjust = 1)

```


##### Step 7

Use the fitted linear model to predict the number of individuals that would be supported on two new mussel clumps with areas of 8000 and 10000 mm$^2$.

```{r}
10^predict(peake.lm, data.frame(AREA = c(8000, 10000)))
```

Since OLS was used to generate the predictive model, and yet there was likely to have been uncertainty in the original mussel clump area measurements, confidence intervals about these predictions are not valid. Nevertheless, the following illustrates how they would be obtained.


```{r}
10^predict(peake.lm, data.frame(AREA = c(8000, 10000)), interval = "prediction")
```

Similarly, confidence bands could be incorporated onto the plot to indicate confidence in the population regression line if there was no uncertainty in the predictor variable.

