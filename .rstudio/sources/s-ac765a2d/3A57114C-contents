
# load themes,data, packages-----------
source("kira_masterarbeit_edit_190418.R")
source("mytheme.R")
detach("package:psych", unload=TRUE) # attention psych and ggplot do not well togheter
library(cowplot)
library(lme4)
library(nlme)

# do some descriptive plots-------------

dat <- data_wide %>%
  # filter(!duplicated(raw_data3$Patientencode)) %>%
  dplyr::group_by(sex) %>% 
  dplyr::summarise(tot = n()) %>%
  mutate(pct = tot / sum(tot))

ggplot(dat, aes(x = sex, y = pct)) + 
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = scales::percent) +
  geom_text(aes(label = tot), position = position_dodge(width = 1),vjust = -.25) +
  mytheme

dat <- data_wide %>%
  # filter(!duplicated(raw_data3$Patientencode)) %>%
  dplyr::group_by(trans) %>% 
  dplyr::summarise(tot = n()) %>%
  mutate(pct = tot / sum(tot))

ggplot(dat, aes(x = trans, y = pct)) + 
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = scales::percent) +
  geom_text(aes(label = tot), position = position_dodge(width = 1),vjust = -.25, size = 9) +
  mytheme


# dat <- raw_data3 %>% filter(grepl("T0_phq15|T1_phq15", .$variable))
# 
# ggplot(dat, aes(x = variable, y = value, color = Patientencode, group = Patientencode)) +
#   geom_point() +
#   geom_line() +
#   guides(color = F)

#####
# descriptive analyse

# geschlecht, alter, bildung über alles----------
table(data_wide$sex)
psych::describe(data_wide$age, na.rm = T) # one missing => which(is.na(data_wide$age))
Hmisc::describe(data_wide$educ)

# geschlecht und transfer----------
CrossTable(data_wide$sex, data_wide$trans, fisher = T, chisq = T) # n.s. => seems weird for me => check out graphic
fisher.test(data_wide$sex, data_wide$trans) # n.s
chisq.test(data_wide$sex, data_wide$trans) # n.s

dat <- data_wide %>%
  group_by(sex, trans) %>%
  dplyr::summarise(tot = n()) %>% 
  mutate(pct = tot / sum(tot)) %>%
  ungroup() %>%
  mutate(sex = ifelse(is.na(.$sex), "Unbekannt", sex)) %>%
  complete(sex, trans, fill = list(tot = 0, pct = 0)) # complete cases with value 0

ggplot(dat, aes(x = sex, y = tot, fill = trans)) +
  geom_bar(stat = "identity", position = position_dodge()) + 
  mytheme


# age_groups and transfer---------
CrossTable(data_wide$age_group, data_wide$trans, fisher = T) # n.s.

dat <- data_wide %>%
  group_by(age_group, trans) %>%
  dplyr::summarise(tot = n()) %>% 
  mutate(pct = tot / sum(tot)) %>%
  ungroup() %>%
  mutate(age_group = ifelse(is.na(.$age_group), "Unbekannt", age_group)) %>%
  complete(age_group, trans, fill = list(tot = 0, pct = 0)) # complete cases with value 0

ggplot(dat, aes(x = age_group, y = tot, fill = trans)) +
  geom_bar(stat = "identity", position = position_dodge()) + 
  mytheme


# bildung und transfer---------
CrossTable(data_wide$educ, data_wide$trans, fisher = T) # signifikante unterschiede 

dat <- data_wide %>%
  group_by(educ, trans) %>%
  dplyr::summarise(tot = n()) %>% 
  mutate(pct = tot / sum(tot)) %>%
  ungroup() %>%
  mutate(educ = ifelse(is.na(.$educ), "Unbekannt", educ)) %>%
  complete(educ, trans, fill = list(tot = 0, pct = 0)) # complete cases with value 0

ggplot(dat, aes(x = dat$educ, y = dat$tot, fill = dat$trans)) +
  geom_bar(stat = "identity", position = position_dodge()) + 
  mytheme # is not working => attention detach psych package

# geschlecht und bedingung--------------
CrossTable(data_wide$sex, data_wide$condit, fisher = T, chisq = T) # one missing, n.s.

# Altersgruppen und Bedingung--------
CrossTable(data_wide$age_group, data_wide$condit, fisher = T) # n.s

dat <- data_wide %>%
  group_by(age_group, condit) %>%
  dplyr::summarise(tot = n()) %>% 
  mutate(pct = tot / sum(tot)) %>%
  ungroup() %>%
  mutate(age_group = ifelse(is.na(.$age_group), "Unbekannt", age_group)) %>%
  complete(age_group, condit, fill = list(tot = 0, pct = 0)) # complete cases with value 0

ggplot(dat, aes(x = age_group, y = tot, fill = condit)) +
  geom_bar(stat = "identity", position = position_dodge()) + 
  mytheme

# Bildung und Bedingung
CrossTable(data_wide$educ, data_wide$condit, fisher = T) # n.s. 


dat <- data_wide %>%
  group_by(educ, condit) %>%
  dplyr::summarise(tot = n()) %>% 
  mutate(pct = tot / sum(tot)) %>%
  ungroup() %>%
  mutate(educ = ifelse(is.na(.$educ), "Unbekannt", educ)) %>%
  complete(educ, condit, fill = list(tot = 0, pct = 0)) # complete cases with value 0

ggplot(dat, aes(x = dat$educ, y = dat$tot, fill = dat$condit)) +
  geom_bar(stat = "identity", position = position_dodge()) + 
  mytheme # is not working => attention detach psych package


#############
# konfirmatorische analyse und hypothesen testung

# h1a: unterschied trans zu phq_9 t0--------
# achtung unterschiedliche gruppengrösse => welch-test (default bei t-test!)

# daselbe für ein subsample resp. diejenigen personen ausschliessen die bei t1 weggefallen sind

# schaue boxplots an => varianzhomogenität gegeben
ggplot(data_wide, aes( y = T0_phq9, x = data_wide$trans)) +
  geom_boxplot() # varianzen fast gleich, verteilung aber nicht (PR rechtsschief)

t.test(data_wide$T0_phq9 ~ data_wide$trans) # n.s.
# summary(aov(data_wide$T0_phq9 ~ data_wide$trans))

# h1b: unterschied phq_9 t0 und t1 mit trans
# achtung abhängige datenpunkte => Wilcoxon-Test für zwei abhängige Stichproben
# achtung unterschiedliche gruppengrössen

# subsample
dat <- data_wide[data_wide$condit == "Intervention",] # nehme nur personen aus der Intervention (telefongespräche)

# h1b:schaue boxplots an--------
p1 <- ggplot(dat, aes(y = dat$T0_phq9 , x = trans)) +
  geom_boxplot() # dont look very nice :(

ggplot(dat, aes(x = dat$T0_phq9 )) + geom_histogram()

p2 <- ggplot(dat, aes(y = dat$T1_phq9 , x = trans)) +
  geom_boxplot() # looks good

plot_grid(p1, p2, ncol = 2)

# h1b:versuche das ganze zu plotten-------
pat <- ("T0_phq9|T1_phq9")
dat1 <- data_long[grepl(pat, data_long$variable) & data_long$condit == "Intervention",]

# h1b:balkendiagramm--------
ggplot(dat1, aes(x = as.character(variable), y = value, fill = trans)) +
  geom_bar(stat = "identity", position = position_dodge())

# h1b:linienplot (mit mittelwerten)-------
dat2 <- dat1 %>%
  group_by(variable, trans) %>%
  summarise(mean_t = mean(value))

p <- ggplot(dat2, aes(x = as.character(variable), y = mean_t, shape = trans, group = trans)) + 
  geom_point() +
  geom_line() +
  scale_y_continuous(breaks = seq(0,20,5), limits = c(0,20))


# h1b:test over all--------
wilcox.test(dat$T0_phq9, dat$T1_phq9, paired = T) # über alles hoch signifikant


# h1b:test over group an time--------
dat1$variable <- as.character(dat1$variable)
av1 <- aov(dat1$value ~ dat1$variable * dat1$trans) # take long format 
summary.lm(av1)

library(ggfortify) # dont look that bad
autoplot(av1)

boxplot(dat1$value~dat1$variable + dat1$trans)

# test with glm-------
lm1 <- lmer(dat1$value ~ dat1$variable * dat1$trans + (1|dat1$Patientencode))
summary(lm1)
isSingular(lm1)

lm2 <- lme(value ~ variable * trans, data = dat1, random = ~ Patientencode) # not working

# durchschnitt von t0 und t1 nehmen und überprüfen 
# source here: https://www.researchgate.net/post/How_to_compare_two_groups_with_multiple_measurements

# h2a: unterschied trans zu fptm zu allen einzelnen items => bildung summenscore nicht möglich ()
t.test(data_$variable)

#h2b: unterschied phq_9 t0 und t1 mit trans und fptm
#glmm oder anova mit interaction 


#h3: unterschied gad_7 t0 und t1 mit trans



#h4: unterschied phq_15 t0 und t1 mit trans  